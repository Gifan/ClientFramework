const CCInspectorPluginMsg=window.CCInspectorPluginMsg;let inspector={log(){1===arguments.length||2===arguments.length||arguments.length},initByApi(){this.init(function(e,t,o){this.onWebSocketInit(e,t)}.bind(this))},init(e){cc.log("[cc-inspector] 插件启动中..."),cc.loader.loadRes("cc-inspector",function(t,o){if(t)cc.log("[cc-inspector] 获取插件配置失败,请检查是否打开插件!");else{let t=o.host,n=o.port,i=o.isRunInGameStart;if(void 0===t&&void 0===n&&(t=o.json.host,n=o.json.port,i=o.json.isRunInGameStart),void 0!==t&&void 0!==n){if(void 0===t)return void cc.log("[cc-inspector] 插件配置host有误!");if(void 0===n)return void cc.log("[cc-inspector] 插件配置port有误!");e&&e(t,n,i)}else cc.log("[cc-inspector] 未获取到插件配置")}}.bind(this))},initInspector(){window.inspectorGameMemoryStorage=window.inspectorGameMemoryStorage||{},cc.director.once(cc.Director.EVENT_AFTER_SCENE_LAUNCH,function(){this.init(function(e,t,o){o?(cc.log("[cc-inspector] 插件自动启动成功!"),this.onWebSocketInit(e,t)):cc.log("[cc-inspector] 插件未自动运行,你可以在项目中使用相关接口运行插件!")}.bind(this))}.bind(this))},_collectNodeInfo(e,t){if(e){let o=[];return t&&(o=this._getNodeComponentsInfo(e)),{name:e.name,active:e.active,uuid:e.uuid,type:e.constructor.name,x:e.x,y:e.y,zIndex:e.zIndex,childrenCount:e.childrenCount,children:[],width:e.width,height:e.height,color:{r:e.color.r,g:e.color.g,b:e.color.b,a:e.color.a},opacity:e.opacity,rotation:e.rotation,rotationX:e.rotationX,rotationY:e.rotationY,anchorX:e.anchorX,anchorY:e.anchorY,scaleX:e.scaleX,scaleY:e.scaleY,skewX:e.skewX,skewY:e.skewY,components:o}}return null},getNodeInfo(e){let t=window.inspectorGameMemoryStorage[e];return t?this._collectNodeInfo(t,!0):null},_getComponentPropertyData(e){let t=null;if("object"==typeof e){if(cc.Enum.isEnum(e))return cc.Enum.getList(e);t=e.constructor}else t=this._getCompClassId(e);let o=[];if(t){let n=t.__props__;if(n){for(let e=0;e<n.length;){let t=n[e];"_"===t[0]||"node"===t||"uuid"===t||"name"===t||"enabled"===t||"enabledInHierarchy"===t?n.splice(e,1):e++}for(let t=0;t<n.length;t++){let i=n[t],c=cc.Class.attr(e,i),s=null;c&&c.tooltip&&(s=c.tooltip);let r=e[i],l=this._getDataType(r);if(l){let e={name:i,tooltip:s,property:i,type:l,value:r};o.push(e)}}}}return o},_getDataType(e){let t="";return null===e?t="null":null!==e&&"object"==typeof e?(e=e.constructor,t=cc.js.getClassName(e)):t="boolean"==typeof e?cc.Boolean:"string"==typeof e?cc.String:"number"==typeof e?"number":cc.js.getClassName(e),""===t?null:-1===[cc.js.getClassName(cc.Size),cc.js.getClassName(cc.Enum),cc.js.getClassName(cc.Vec2),cc.js.getClassName(cc.Color),cc.Boolean,cc.String,"number","null"].toString().indexOf(t)?null:t},_getCompClassId:e=>("object"==typeof e&&(e=e.constructor),cc.js._getClassId(e)),_getNodeComponentsInfo(e){let t=[],o=e._components;for(let e=0;e<o.length;e++){let n=o[e];window.inspectorGameMemoryStorage[n.uuid]=n;let i=this._getComponentPropertyData(n),c={uuid:n.uuid,name:cc.js.getClassName(n),type:n.constructor.name,enabled:n.enabled,property:i};t.push(c)}return t},_collectChildrenInfo(e,t){let o=this._collectNodeInfo(e,!1);window.inspectorGameMemoryStorage[e.uuid]=e;let n=e.getChildren();for(let e=0;e<n.length;e++){let t=n[e];this._collectChildrenInfo(t,o.children)}t.push(o)},_collectTreeInfo(){let e=[],t=cc.director.getScene().getChildren();for(let o=0;o<t.length;o++){let n=t[o];this._collectChildrenInfo(n,e)}return e},wsSend(e,t){if(this.ws){let o={code:e,data:t},n=JSON.stringify(o);cc.sys.isBrowser,this.ws.send(n)}},_isPluginInit:!1,onWebSocketInit(e,t){if(!1!==this._isPluginInit)return void cc.log("[cc-inspector] 插件已经初始化,无需重复调用!");this._isPluginInit=!0,this.ws&&this.ws.close();let o=`ws://${e}:${t}`;this.ws=new WebSocket(o),this.ws.onopen=function(){cc.log("[open] 成功链接调试服务器: "+o),this.wsSend(CCInspectorPluginMsg.Msg.Test,"hello cc-inspector!")}.bind(this),this.ws.onmessage=function(e){cc.sys.isBrowser;let t=JSON.parse(e.data),o=t.code,n=t.data;if(o===CCInspectorPluginMsg.Msg.GetTreeInfo){let e=this._collectTreeInfo();this.wsSend(CCInspectorPluginMsg.Msg.GetTreeInfo,e)}else if(o===CCInspectorPluginMsg.Msg.GetNodeInfo){let e=this.getNodeInfo(n);e&&this.wsSend(CCInspectorPluginMsg.Msg.GetNodeInfo,e)}else if(o===CCInspectorPluginMsg.Msg.Position){let e=n.uuid,t=n.data,o=window.inspectorGameMemoryStorage[e];o&&(o.x=t.x,o.y=t.y)}else if(o===CCInspectorPluginMsg.Msg.Opacity){let e=n.uuid,t=n.data,o=window.inspectorGameMemoryStorage[e];o&&(o.opacity=t)}else if(o===CCInspectorPluginMsg.Msg.Anchor){let e=n.uuid,t=n.data,o=window.inspectorGameMemoryStorage[e];o&&(o.anchorX=t.x,o.anchorY=t.y)}else if(o===CCInspectorPluginMsg.Msg.Size){let e=n.uuid,t=n.data,o=window.inspectorGameMemoryStorage[e];o&&(o.width=t.width,o.height=t.height)}else if(o===CCInspectorPluginMsg.Msg.Scale){let e=n.uuid,t=n.data,o=window.inspectorGameMemoryStorage[e];o&&(o.scaleX=t.x,o.scaleY=t.y)}else if(o===CCInspectorPluginMsg.Msg.Rotation){let e=n.uuid,t=n.data,o=window.inspectorGameMemoryStorage[e];o&&(o.rotation=t)}else if(o===CCInspectorPluginMsg.Msg.Skew){let e=n.uuid,t=n.data,o=window.inspectorGameMemoryStorage[e];o&&(o.skewX=t.x,o.skewY=t.y)}else if(o===CCInspectorPluginMsg.Msg.Color){let e=n.uuid,t=n.data,o=window.inspectorGameMemoryStorage[e];o&&(o.color=cc.color(t))}else if(o===CCInspectorPluginMsg.Msg.Active){let e=n.uuid,t=n.data,o=window.inspectorGameMemoryStorage[e];o&&(o.active=t)}}.bind(this),this.ws.onerror=function(){this.ws=null,cc.log("[cc-inspector] error: 游戏连接插件失败,请打开插件后,重新运行游戏!")}.bind(this),this.ws.onclose=function(){this.ws=null,cc.log("[cc-inspector] close: 游戏与插件断开链接,请打开插件后,重新运行游戏!")}.bind(this)}};inspector.initInspector(),window.CCInspectorPlugin={init:inspector.initByApi.bind(inspector),collectTreeInfo:inspector._collectTreeInfo.bind(inspector),getNodeInfo:inspector.getNodeInfo.bind(inspector)};